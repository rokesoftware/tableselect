/**
 * @preserve
 * TableSelect - jQuery Plugin
 * Version: 0.1.0
 * Requires jQuery v2.0 or later
 *
 * Examples at http://tadeaspetak.net/roke/tableselect/
 * License: https://github.com/rokesoftware/tableselect/blob/master/License
 *
 * Copyright 2014 Roke Software - info@roke.cz
 *
 */
Number.prototype.fitIn||(Number.prototype.fitIn=function(min,max){var self=this;return self=Math.max(self,min),self=Math.min(self,max)}),function($){$.fn.scrollTo=function(){if(this.size()){var yScroll=$(document).scrollTop(),viewportHeight=window.innerHeight,elTop=this.offset().top,elHeight=this.outerHeight();elTop+elHeight>yScroll+viewportHeight?$(window).scrollTop(elTop+elHeight-viewportHeight):yScroll>elTop&&$(window).scrollTop(elTop)}return this},$.widget("roke.tableselect",{options:{selected:"selected",selectedExtra:"info",selectionStart:"selection-start",selectionEnd:"selection-end",ignore:".table-select-ignore"},_create:function(){this.$el=this.element,this._on(this.$el,{mousedown:function(e){e.shiftKey&&this.$el.disableSelection()},mouseup:function(){this.$el.enableSelection()},"click tbody tr":function(e){var $row=$(e.currentTarget);0!==this.getAll().filter($row).size()&&(e.ctrlKey?this.isSelected($row)?this.unselect($row):this.select($row,{asFirst:!0,asLast:!0}):e.shiftKey?this.selectRange(this.getAll().index(this.getSelectionStart(!0)),this.getAll().index($row)):this.isSelected($row)&&this.getSelected().size()<2?this.unselect($row):(this.unselect(this.getSelected(),{followedBySelect:!0}),this.select($row,{asFirst:!0})))}}),this._on($(document),{keydown:function(e){var focused=$(":focus").size();switch(e.which){case 38:if(focused)return;if(e.stopPropagation(),e.preventDefault(),e.shiftKey)0===this.getSelected().size()&&this.select(this.getAll().last(),{asFirst:!0}),this.selectRange(this.getAll().index(this.getSelectionStart()),this.getAll().index(this.getSelectionEnd())-1);else{var $selectionEnd=this.getSelectionEnd();this.unselect(this.getSelected(),{followedBySelect:!0}),0===$selectionEnd.size()||0===this.getAll().index($selectionEnd)?this.select(this.getAll().last(),{asFirst:!0}):this.select(this.previous($selectionEnd),{asFirst:!0})}break;case 40:if(focused)return;if(e.stopPropagation(),e.preventDefault(),e.shiftKey)this.selectRange(this.getAll().index(this.getSelectionStart(!0)),this.getAll().index(this.getSelectionEnd())+1);else{var $selectionEnd=this.getSelectionEnd();this.unselect(this.getSelected(),{followedBySelect:!0}),0===$selectionEnd.size()||this.getAll().index($selectionEnd)>=this.getAll().size()-1?this.select(this.getAll().first(),{asFirst:!0}):this.select(this.next($selectionEnd),{asFirst:!0})}break;case 65:e.ctrlKey&&!focused&&(e.stopPropagation(),e.preventDefault(),this.select(this.getAll(),{all:!0}));break;case 27:if(focused)return;e.stopPropagation(),e.preventDefault(),this.unselect(this.getAll(),{all:!0})}}}),this._on(this.$el,{tableselectchange:function(){this.getSelectionEnd().scrollTo()}}),this._trigger("change",{init:!0})},isSelected:function($row){return $row.hasClass(this.options.selected)},unselect:function($rows,options){return options=$.extend({skipFirst:!1,trigger:!0,followedBySelect:!1},options),options.skipFirst&&($rows.filter("."+this.options.selectionStart).removeClass(this.options.selectionEnd),$rows=$rows.not("."+this.options.selectionStart)),$rows.removeClass(this.options.selected).removeClass(this.options.selectedExtra).removeClass(this.options.selectionStart).removeClass(this.options.selectionEnd),options.trigger&&this._trigger("change",null,{rows:$rows,type:"unselect",followedBySelect:options.followedBySelect}),$rows},select:function($rows,options){return options=$.extend({asFirst:!1,asLast:!1,trigger:!0},options),options.asFirst&&(this.getAll().removeClass(this.options.selectionStart),$rows.addClass(this.options.selectionStart)),options.asLast&&(this.getAll().removeClass(this.options.selectionEnd),$rows.addClass(this.options.selectionEnd)),$rows.addClass(this.options.selected).addClass(this.options.selectedExtra),options.trigger&&this._trigger("change",null,{rows:$rows,type:"select"}),$rows},selectRange:function(start,end){var rowCount=this.getAll().size();start=start.fitIn(0,rowCount-1),end=end.fitIn(0,rowCount-1),this.unselect(this.getSelected(),{skipFirst:!0,followedBySelect:!0});var difference=end-start;if(difference>0)for(var i=start+1;end>=i;i+=1)this.select(this.getAll().eq(i),{trigger:!1});else for(var i=start-1;i>=end;i-=1)this.select(this.getAll().eq(i),{trigger:!1});this.getAll().eq(end).addClass(this.options.selectionEnd),this._trigger("change",null,{type:"select",rows:this.getSelected()})},getAll:function(refresh){return(!this.$all||refresh)&&this.refresh(),this.$all},refresh:function(){var $all=this.$el.find("tbody tr");"string"==typeof this.options.ignore?$all=$all.not(this.options.ignore):"function"==typeof this.options.ignore&&($all=this.options.ignore.call(this,this,$all)),this.$all=$all},getSelected:function(){return this.getAll().filter("."+this.options.selected)},getSelectionStart:function(force){force=force||!1;var $start=this.getAll().filter("."+this.options.selectionStart);return 0===$start.size()&&force&&($start=this.select(this.getAll().eq(0),{asFirst:!0})),$start},getSelectionEnd:function(force){force=force||!1;var $end=this.getAll().filter("."+this.options.selectionEnd);return 0===$end.size()&&($end=this.getSelectionStart(force)),$end},previous:function($row){var $prev=this.getAll().eq(this.getAll().index($row)-1);return $prev.size()?$prev:!1},next:function($row){var $next=this.getAll().eq(this.getAll().index($row)+1);return $next.size()?$next:!1}})}(jQuery);